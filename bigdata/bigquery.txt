SELECT aa.SK_ID_CURR, 
  CASE
    WHEN NAME_CONTRACT_TYPE='Cash loans' THEN 1
    WHEN NAME_CONTRACT_TYPE='Revolving loans' THEN 0
    ELSE -1
  END AS IS_CASH_LOAN,
  CASE
    WHEN CODE_GENDER='M' THEN 1
    WHEN CODE_GENDER='F' THEN 0
    ELSE -1
  END AS IS_MALE,
  CASE
    WHEN FLAG_OWN_CAR THEN 1
    ELSE 0
  END AS IS_OWN_CAR,
  CASE
    WHEN FLAG_OWN_REALTY THEN 1
    ELSE 0
  END AS IS_OWN_REALTY,
  CNT_CHILDREN,
  AMT_INCOME_TOTAL,
  AMT_CREDIT,
  AMT_ANNUITY,
  AMT_GOODS_PRICE,
  CASE
    WHEN NAME_TYPE_SUITE='Unaccompanied' THEN 0
    ELSE 1
  END AS IS_ACCOMPANIED,
  MEAN_INCOME_TYPE,
  CASE
    WHEN NAME_EDUCATION_TYPE='Lower secondary' THEN 1
    WHEN NAME_EDUCATION_TYPE='Secondary / secondary special' THEN 2
    WHEN NAME_EDUCATION_TYPE='Incomplete higher' THEN 3
    WHEN NAME_EDUCATION_TYPE='Higher education' THEN 4
    WHEN NAME_EDUCATION_TYPE='Academic degree' THEN 5
    ELSE -1
  END AS EDUCATION_TYPE,
  MEAN_FAMILY_STATUS,
  MEAN_HOUSING_TYPE,
  REGION_POPULATION_RELATIVE,
  DAYS_BIRTH,
  DAYS_EMPLOYED,
  DAYS_REGISTRATION,
  DAYS_ID_PUBLISH,
  OWN_CAR_AGE,
  FLAG_MOBIL,
  FLAG_EMP_PHONE,
  FLAG_CONT_MOBILE,
  FLAG_PHONE,
  FLAG_EMAIL,
  MEAN_OCCUPATION_TYPE,
  CNT_FAM_MEMBERS,
  REGION_RATING_CLIENT,
  REGION_RATING_CLIENT_W_CITY,
  MEAN_ORGANIZATION_TYPE,
  HOUR_APPR_PROCESS_START,
  REG_REGION_NOT_LIVE_REGION,
  REG_REGION_NOT_WORK_REGION,
  LIVE_REGION_NOT_WORK_REGION,
  REG_CITY_NOT_LIVE_CITY,
  REG_CITY_NOT_WORK_CITY,
  LIVE_CITY_NOT_WORK_CITY,
  EXT_SOURCE_1,
  EXT_SOURCE_2,
  EXT_SOURCE_3,
  DAYS_LAST_PHONE_CHANGE,
  FLAG_DOCUMENT_2,
  FLAG_DOCUMENT_3,
  FLAG_DOCUMENT_4,
  FLAG_DOCUMENT_5,
  FLAG_DOCUMENT_6,
  FLAG_DOCUMENT_7,
  FLAG_DOCUMENT_8,
  FLAG_DOCUMENT_9,
  FLAG_DOCUMENT_10,
  FLAG_DOCUMENT_11,
  FLAG_DOCUMENT_12,
  FLAG_DOCUMENT_13,
  FLAG_DOCUMENT_14,
  FLAG_DOCUMENT_15,
  FLAG_DOCUMENT_16,
  FLAG_DOCUMENT_17,
  FLAG_DOCUMENT_18,
  FLAG_DOCUMENT_19,
  FLAG_DOCUMENT_20,
  FLAG_DOCUMENT_21,
  AMT_REQ_CREDIT_BUREAU_HOUR,
  AMT_REQ_CREDIT_BUREAU_DAY,
  AMT_REQ_CREDIT_BUREAU_WEEK,
  AMT_REQ_CREDIT_BUREAU_MON,
  AMT_REQ_CREDIT_BUREAU_QRT,
  AMT_REQ_CREDIT_BUREAU_YEAR,
  WEEKDAY_SIN, 
  WEEKDAY_COS
FROM
`eco-codex-235412.home_credit.application_train` aa
INNER JOIN
(
SELECT SK_ID_CURR, SIN(2 * 3.14 * (WEEKDAY/7)) AS WEEKDAY_SIN, COS(2 * 3.14 * (WEEKDAY/7)) AS WEEKDAY_COS
  FROM
  (
  SELECT 
    SK_ID_CURR, 
    CASE
      WHEN WEEKDAY_APPR_PROCESS_START='SUNDAY' THEN 1
      WHEN WEEKDAY_APPR_PROCESS_START='MONDAY' THEN 2
      WHEN WEEKDAY_APPR_PROCESS_START='TUESDAY' THEN 3
      WHEN WEEKDAY_APPR_PROCESS_START='WEDNESDAY' THEN 4
      WHEN WEEKDAY_APPR_PROCESS_START='THURSDAY' THEN 5
      WHEN WEEKDAY_APPR_PROCESS_START='FRIDAY' THEN 6
      ELSE 7
    END AS WEEKDAY
  FROM 
    `eco-codex-235412.home_credit.application_train`
)
) ab 
ON aa.SK_ID_CURR = ab.SK_ID_CURR
INNER JOIN
(
  SELECT 
    NAME_INCOME_TYPE, COUNT(TARGET)/(SELECT COUNT(*) FROM  `eco-codex-235412.home_credit.application_train`) AS MEAN_INCOME_TYPE
  FROM 
    `eco-codex-235412.home_credit.application_train`
  WHERE 
    TARGET = 1
  GROUP BY
    NAME_INCOME_TYPE
) ac
ON aa.NAME_INCOME_TYPE = ac.NAME_INCOME_TYPE
INNER JOIN
(
  SELECT 
    NAME_FAMILY_STATUS, COUNT(TARGET)/(SELECT COUNT(*) FROM  `eco-codex-235412.home_credit.application_train`) AS MEAN_FAMILY_STATUS
  FROM 
    `eco-codex-235412.home_credit.application_train`
  WHERE 
    TARGET = 1
  GROUP BY
    NAME_FAMILY_STATUS
) ad
ON aa.NAME_FAMILY_STATUS = ad.NAME_FAMILY_STATUS
INNER JOIN
(
  SELECT 
    NAME_HOUSING_TYPE, COUNT(TARGET)/(SELECT COUNT(*) FROM  `eco-codex-235412.home_credit.application_train`) AS MEAN_HOUSING_TYPE
  FROM 
    `eco-codex-235412.home_credit.application_train`
  WHERE 
    TARGET = 1
  GROUP BY
    NAME_HOUSING_TYPE
) ae
ON aa.NAME_HOUSING_TYPE = ae.NAME_HOUSING_TYPE
INNER JOIN
(
  SELECT 
    OCCUPATION_TYPE, COUNT(TARGET)/(SELECT COUNT(*) FROM  `eco-codex-235412.home_credit.application_train`) AS MEAN_OCCUPATION_TYPE
  FROM 
    `eco-codex-235412.home_credit.application_train`
  WHERE 
    TARGET = 1
  GROUP BY
    OCCUPATION_TYPE
) af
ON aa.OCCUPATION_TYPE = af.OCCUPATION_TYPE
INNER JOIN
(
  SELECT 
    ORGANIZATION_TYPE, COUNT(TARGET)/(SELECT COUNT(*) FROM  `eco-codex-235412.home_credit.application_train`) AS MEAN_ORGANIZATION_TYPE
  FROM 
    `eco-codex-235412.home_credit.application_train`
  WHERE 
    TARGET = 1
  GROUP BY
    ORGANIZATION_TYPE
) ag
ON aa.ORGANIZATION_TYPE = ag.ORGANIZATION_TYPE
